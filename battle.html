<!doctype html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>OPEN WAR</title>
</head>
<body>
<section>
<div>
    <canvas id="canvas" width="1000" height="400">
        This text is displayed if your browser does not support HTML5 Canvas.
    </canvas>
</div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>

    <script type="text/javascript">

        var WIDTH = 1000; //the ground
        var HEIGHT = 400;
        var client_id ;

        var canvas;
        var ctx;

        var socket = io('/survive-room');
        var Players =[] ;
        var Fires =[];

        function circle(x,y,r){
            ctx.beginPath();
            ctx.arc(x,y,r,0,Math.PI*2,true);
            ctx.fill();
        }

        function rect(x,y,w,h){
            ctx.beginPath();
            ctx.rect(x,y,w,h);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }

        function clear() {
            ctx.clearRect(0,0,WIDTH,HEIGHT);
        }


        function draw() {
            clear();
            ctx.fillStyle= "white";
            ctx.strokeStyle= "black";
            rect(0,0,WIDTH,HEIGHT);

            for(var i=0 ; i<Players.length ;i++){
                ctx.fillStyle = "purple";
                circle(Players[i].x,Players[i].y,10);
            }

            for(var i=0 ; i<Fires.length ;i++){
                ctx.fillStyle = "purple";
                circle(Fires[i].x,Fires[i].y,2);
            }


        }
        

        function doKeyDown(evt){
            socket.emit('move_request',evt.keyCode);
            socket.emit('MY position');
        }





        function identification() {
            return new Promise(function (resolve) {

                socket.on('identification', function (id) {
                    socket.emit('test',"resolving the new player id");
                    resolve(id);
                    client_id = id;

                })

            });
        }




        async function init() {
            socket.emit('init');
            await identification();
            socket.emit('print my id', client_id);
            socket.emit("test","initialization finish");

        }





        async function update(){
            socket.emit('test',"number of players now equal : "+Players.length);
            socket.emit('test','asking for update players list');
            socket.emit('update request');
            socket.emit('test','start for response the update');

            await  new Promise(function (resolve) {
                socket.on('update response', function (Players_arg,Fires_arg) {
                    socket.emit('test','inside updating process');
                    resolve(Players_arg);
                    resolve(Fires_arg);
                    Players=Players_arg;
                    Fires=Fires_arg;
                    client_id = id;
                })
            });

            socket.emit('test','finish update');
        }






        /****************************************************************************************************************
         * the Main start from here
         */


        socket.emit('test',"before asyncCall");
        init();



        canvas = document.getElementById("canvas");
        ctx = canvas.getContext("2d");
        setInterval(draw,10);
        setInterval(update,200);


        window.addEventListener('keydown',doKeyDown,true);












    </script>

</section>
</body>
</html>